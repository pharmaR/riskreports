# Matrix obtained from choose a license see inst/choosealicense.R last update 28/02/2025
license_info <- structure(c("BSD Zero Clause License", "Academic Free License v3.0",
            "GNU Affero General Public License v3.0", "Apache License 2.0",
            "Artistic License 2.0", "Blue Oak Model License 1.0.0", "BSD-2-Clause Plus Patent License",
            "BSD 2-Clause \"Simplified\" License", "BSD 3-Clause Clear License",
            "BSD 3-Clause \"New\" or \"Revised\" License", "BSD 4-Clause \"Original\" or \"Old\" License",
            "Boost Software License 1.0", "Creative Commons Attribution 4.0 International",
            "Creative Commons Attribution Share Alike 4.0 International",
            "Creative Commons Zero v1.0 Universal", "CeCILL Free Software License Agreement v2.1",
            "CERN Open Hardware Licence Version 2 - Permissive", "CERN Open Hardware Licence Version 2 - Strongly Reciprocal",
            "CERN Open Hardware Licence Version 2 - Weakly Reciprocal", "Educational Community License v2.0",
            "Eclipse Public License 1.0", "Eclipse Public License 2.0", "European Union Public License 1.1",
            "European Union Public License 1.2", "GNU Free Documentation License v1.3",
            "GNU General Public License v2.0", "GNU General Public License v3.0",
            "ISC License", "GNU Lesser General Public License v2.1", "GNU Lesser General Public License v3.0",
            "LaTeX Project Public License v1.3c", "MIT No Attribution", "MIT License",
            "Mozilla Public License 2.0", "Microsoft Public License", "Microsoft Reciprocal License",
            "Mulan Permissive Software License, Version 2", "University of Illinois/NCSA Open Source License",
            "Open Data Commons Open Database License v1.0", "SIL Open Font License 1.1",
            "Open Software License 3.0", "PostgreSQL License", "The Unlicense",
            "Universal Permissive License v1.0", "Vim License", "Do What The F*ck You Want To Public License",
            "zlib License", "0BSD", "AFL-3.0", "AGPL-3.0", "APACHE-2.0",
            "ARTISTIC-2.0", "BLUEOAK-1.0.0", "BSD-2-CLAUSE-PATENT", "BSD-2-CLAUSE",
            "BSD-3-CLAUSE-CLEAR", "BSD-3-CLAUSE", "BSD-4-CLAUSE", "BSL-1.0",
            "CC-BY-4.0", "CC-BY-SA-4.0", "CC0-1.0", "CECILL-2.1", "CERN-OHL-P-2.0",
            "CERN-OHL-S-2.0", "CERN-OHL-W-2.0", "ECL-2.0", "EPL-1.0", "EPL-2.0",
            "EUPL-1.1", "EUPL-1.2", "GFDL-1.3", "GPL-2.0", "GPL-3.0", "ISC",
            "LGPL-2.1", "LGPL-3.0", "LPPL-1.3C", "MIT-0", "MIT", "MPL-2.0",
            "MS-PL", "MS-RL", "MULANPSL-2.0", "NCSA", "ODBL-1.0", "OFL-1.1",
            "OSL-3.0", "POSTGRESQL", "UNLICENSE", "UPL-1.0", "VIM", "WTFPL",
            "ZLIB", "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", NA, "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", NA, "limitations", NA, NA, NA, "limitations",
            "limitations", "limitations", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", NA, NA, "permisive", NA, NA, "permisive", NA, NA,
            NA, "permisive", "permisive", "permisive", "permisive", NA, "limitations",
            NA, "permisive", NA, NA, "permisive", NA, NA, NA, "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", "permisive", "permisive", "permisive", "permisive",
            "permisive", NA, NA, "conditions", NA, NA, NA, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, "conditions", NA, "conditions", "conditions",
            NA, "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", NA, "conditions", "conditions", "conditions",
            NA, NA, "conditions", NA, "conditions", NA, NA, "conditions",
            NA, "conditions", NA, NA, NA, "conditions", NA, NA, NA, "conditions",
            "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", NA, "conditions", "conditions", "conditions",
            "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", "conditions", NA, "conditions", "conditions",
            "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", "conditions", NA, "conditions", "conditions",
            NA, "conditions", NA, NA, "conditions", NA, NA, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, "conditions", NA, NA, NA, NA, NA, NA,
            "conditions", "conditions", NA, NA, NA, NA, NA, NA, NA, NA, NA,
            NA, NA, NA, NA, NA, NA, NA, "conditions", NA, NA, NA, NA, NA,
            NA, NA, NA, "conditions", NA, NA, NA, NA, NA, NA, NA, NA, NA,
            NA, "conditions", NA, "conditions", NA, "conditions", "conditions",
            NA, "conditions", "conditions", "conditions", "conditions", "conditions",
            "conditions", "conditions", NA, "conditions", "conditions", NA,
            NA, NA, "conditions", NA, "conditions", NA, NA, "conditions",
            "conditions", "conditions", NA, NA, NA, "conditions", NA, NA,
            NA, "conditions", "conditions", "conditions", "conditions", NA,
            NA, NA, NA, NA, NA, NA, "conditions", "conditions", NA, NA, "conditions",
            "conditions", "conditions", "conditions", NA, NA, "conditions",
            "conditions", "conditions", "conditions", "conditions", NA, "conditions",
            "conditions", "conditions", NA, NA, NA, NA, NA, NA, NA, NA, NA,
            "conditions", NA, NA, NA, "conditions", NA, "conditions", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", NA, NA, "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", NA, NA, "limitations", NA, "limitations",
            NA, "limitations", "limitations", NA, NA, NA, NA, NA, NA, NA,
            "limitations", "limitations", "limitations", NA, NA, NA, NA,
            "limitations", NA, NA, "limitations", "limitations", NA, NA,
            NA, NA, NA, NA, NA, NA, NA, "limitations", "limitations", "limitations",
            "limitations", NA, "limitations", NA, "limitations", NA, NA,
            NA, NA, NA, NA, "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", "limitations", "limitations", "limitations", "limitations",
            "limitations", NA, NA, "limitations", "https://choosealicense.com//licenses/0bsd",
            "https://choosealicense.com//licenses/afl-3.0", "https://choosealicense.com//licenses/agpl-3.0",
            "https://choosealicense.com//licenses/apache-2.0", "https://choosealicense.com//licenses/artistic-2.0",
            "https://choosealicense.com//licenses/blueoak-1.0.0", "https://choosealicense.com//licenses/bsd-2-clause-patent",
            "https://choosealicense.com//licenses/bsd-2-clause", "https://choosealicense.com//licenses/bsd-3-clause-clear",
            "https://choosealicense.com//licenses/bsd-3-clause", "https://choosealicense.com//licenses/bsd-4-clause",
            "https://choosealicense.com//licenses/bsl-1.0", "https://choosealicense.com//licenses/cc-by-4.0",
            "https://choosealicense.com//licenses/cc-by-sa-4.0", "https://choosealicense.com//licenses/cc0-1.0",
            "https://choosealicense.com//licenses/cecill-2.1", "https://choosealicense.com//licenses/cern-ohl-p-2.0",
            "https://choosealicense.com//licenses/cern-ohl-s-2.0", "https://choosealicense.com//licenses/cern-ohl-w-2.0",
            "https://choosealicense.com//licenses/ecl-2.0", "https://choosealicense.com//licenses/epl-1.0",
            "https://choosealicense.com//licenses/epl-2.0", "https://choosealicense.com//licenses/eupl-1.1",
            "https://choosealicense.com//licenses/eupl-1.2", "https://choosealicense.com//licenses/gfdl-1.3",
            "https://choosealicense.com//licenses/gpl-2.0", "https://choosealicense.com//licenses/gpl-3.0",
            "https://choosealicense.com//licenses/isc", "https://choosealicense.com//licenses/lgpl-2.1",
            "https://choosealicense.com//licenses/lgpl-3.0", "https://choosealicense.com//licenses/lppl-1.3c",
            "https://choosealicense.com//licenses/mit-0", "https://choosealicense.com//licenses/mit",
            "https://choosealicense.com//licenses/mpl-2.0", "https://choosealicense.com//licenses/ms-pl",
            "https://choosealicense.com//licenses/ms-rl", "https://choosealicense.com//licenses/mulanpsl-2.0",
            "https://choosealicense.com//licenses/ncsa", "https://choosealicense.com//licenses/odbl-1.0",
            "https://choosealicense.com//licenses/ofl-1.1", "https://choosealicense.com//licenses/osl-3.0",
            "https://choosealicense.com//licenses/postgresql", "https://choosealicense.com//licenses/unlicense",
            "https://choosealicense.com//licenses/upl-1.0", "https://choosealicense.com//licenses/vim",
            "https://choosealicense.com//licenses/wtfpl", "https://choosealicense.com//licenses/zlib"
), dim = c(47L, 16L), dimnames = list(NULL, c("name", "acronym",
                                              "Commercial use", "Distribution", "Modification", "Patent use",
                                              "Private use", "Disclose source", "License and copyright notice",
                                              "Network use is distribution", "Same license", "State changes",
                                              "Liability", "Trademark use", "Warranty", "url")))


# TODO function for matching R package license information with the table above

#' Find info about a license
#'
#' @param license Character with license info (usually from DESCRIPTION License field)
#'
#' @returns A data.frame with name, acronym, several titles and their permissions and the url to the website.
#' If no is found NULL
#' @export
#'
#' @examples
#' licensing_match("GPL (>= 2.0)")
licensing_match <- function(license) {
  # demo data
  licenses <- license
  out <- gsub( ".? ?file LICENSE|.? ?file LICENCE", "", licenses)
  if (any(grepl(pattern = "+", out, fixed = TRUE))) {
    warning("Please report to the package maintainer: the license is not well cleaned.")
  }
  s <- strsplit(out, " | ", fixed = TRUE)
  df <- as.data.frame(license_info)
  l <- lapply(s, function(x) {
    x <- gsub(" (>= ", "-", trimws(x), fixed = TRUE)
    x <- gsub(" (<= ", "-", x, fixed = TRUE)
    x <- gsub(" (== ", "-", x, fixed = TRUE)
    x <- gsub(" (> ", "-", x, fixed = TRUE)
    x <- gsub(")", "", x, fixed = TRUE)

    k <- grepl("^([AL]?GPL)", x = x) & grepl("-", x, fixed = TRUE) & !endsWith(x, "2.1") & !endsWith(x, ".0")
    x[k] <- paste0(x[k], ".0")

    if (any(k <- startsWith(x, "Apache"))) {
      x[k] <- "APACHE-2.0"
    }
    if (any(k <- x == "FreeBSD")) {
      x[k] <- "0BSD"
    }
    if (any(k <- x == "GNU General Public License")) {
      x[k] <- "GPL"
    }
    if (any(k <- startsWith(x, "CC"))) {
      x[k] <- gsub("[[:space:]]", "-", x[k])
    }
    x <- gsub("_", "-", toupper(x), fixed = TRUE)
    m <- match(x, df$acronym)
    if (any(k <- is.na(m))) {
      o <- grep(paste0("^", x[k]), df$acronym)
      # browser(expr = length(k) > 1)
      if (length(o) == 0L) {
        NA
      } else {
        warning("License not clear")
        suppressWarnings(m[k] <- o)
      }
    }
    m
  })
  out <- df[unlist(l, FALSE, FALSE), , drop = FALSE]
  if (is.na(out$acronym)) {
    return(NULL)
  }
  out
}


#' Create the html tag for linking licenses
#'
#' Creates a link to the <choosealicense.com> website.
#' @param license A data.frame as generated by `licensing_match()`.
#' @returns A html tag with the link to the license.
#' @export
#' @examples
#' license_url(licensing_match("GPL (>= 2.0)"))
license_url <- function(license) {
  if (!NROW(license)) {
    return(NULL)
  }
  paste0("<a href=", license$url, ">", license$acronym, "</a>")
}
